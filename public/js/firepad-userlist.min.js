/*! nodefirenote 2016-01-23 */
var FirepadUserList=function(){function a(b,c,d,e){if(!(this instanceof a))return new a(b,c,d,e);this.ref_=b,this.userId_=d,this.place_=c,this.firebaseCallbacks_=[];var f=this;this.hasName_=!!e,this.displayName_=e||"Guest "+Math.floor(1e3*Math.random()),this.firebaseOn_(b.root().child(".info/connected"),"value",function(a){if(a.val()===!0&&f.displayName_){var c=b.child(f.userId_).child("name");c.onDisconnect().remove(),c.set(f.displayName_)}}),this.userList_=this.makeUserList_(),c.appendChild(this.userList_)}function b(a){return"string"==typeof a&&(a.match(/^#[a-fA-F0-9]{3,6}$/)||"transparent"==a)}function c(a,b,c){var e=document.createElement(a);if("string"==typeof b)d(e,b);else if(b)for(var f=0;f<b.length;++f)e.appendChild(b[f]);for(var g in c||{})e.setAttribute(g,c[g]);return e}function d(a,b){a.innerHTML="",a.appendChild(document.createTextNode(b))}function e(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)}function f(a){a.preventDefault?a.preventDefault():a.returnValue=!1}function g(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0}function h(a){f(a),g(a)}return a.fromDiv=a,a.prototype.dispose=function(){this.removeFirebaseCallbacks_(),this.ref_.child(this.userId_).child("name").remove(),this.place_.removeChild(this.userList_)},a.prototype.makeUserList_=function(){return c("div",[this.makeHeading_(),c("div",[this.makeUserEntryForSelf_(),this.makeUserEntriesForOthers_()],{"class":"firepad-userlist-users"})],{"class":"firepad-userlist"})},a.prototype.makeHeading_=function(){var a=c("span","0");return this.firebaseOn_(this.ref_,"value",function(b){d(a,""+b.numChildren())}),c("div",[c("span","ONLINE ("),a,c("span",")")],{"class":"firepad-userlist-heading"})},a.prototype.makeUserEntryForSelf_=function(){var a=this.ref_.child(this.userId_),d=c("div",null,{"class":"firepad-userlist-color-indicator"});this.firebaseOn_(a.child("color"),"value",function(a){var c=a.val();b(c)&&(d.style.backgroundColor=c)});var f=c("input",null,{type:"text","class":"firepad-userlist-name-input"});f.value=this.displayName_;var g=c("div","ENTER YOUR NAME",{"class":"firepad-userlist-name-hint"});this.hasName_&&(g.style.display="none");var i=this;e(f,"change",function(b){var c=f.value||"Guest "+Math.floor(1e3*Math.random());a.child("name").onDisconnect().remove(),a.child("name").set(c),g.style.display="none",f.blur(),i.displayName_=c,h(b)});var j=c("div",[f,g]);return c("div",[d,j],{"class":"firepad-userlist-user firepad-user-"+this.userId_})},a.prototype.makeUserEntriesForOthers_=function(){function a(a,g){var h=a.key(),i=f[h];i&&(e.removeChild(i),delete f[h]);var j=a.child("name").val();"string"!=typeof j&&(j="Guest"),j=j.substring(0,20);var k=a.child("color").val();b(k)||(k="#ffb");var l=c("div",null,{"class":"firepad-userlist-color-indicator"});l.style.backgroundColor=k;var m=c("div",j||"Guest",{"class":"firepad-userlist-name"}),n=c("div",[l,m],{"class":"firepad-userlist-user firepad-user-"+h});f[h]=n,h===d.userId_&&(n.style.display="none");var o=g?f[g].nextSibling:e.firstChild;e.insertBefore(n,o)}var d=this,e=c("div"),f={};return this.firebaseOn_(this.ref_,"child_added",a),this.firebaseOn_(this.ref_,"child_changed",a),this.firebaseOn_(this.ref_,"child_moved",a),this.firebaseOn_(this.ref_,"child_removed",function(a){var b=a.key(),c=f[b];c&&(e.removeChild(c),delete f[b])}),e},a.prototype.firebaseOn_=function(a,b,c,d){return this.firebaseCallbacks_.push({ref:a,eventType:b,callback:c,context:d}),a.on(b,c,d),c},a.prototype.firebaseOff_=function(a,b,c,d){a.off(b,c,d);for(var e=0;e<this.firebaseCallbacks_.length;e++){var f=this.firebaseCallbacks_[e];if(f.ref===a&&f.eventType===b&&f.callback===c&&f.context===d){this.firebaseCallbacks_.splice(e,1);break}}},a.prototype.removeFirebaseCallbacks_=function(){for(var a=0;a<this.firebaseCallbacks_.length;a++){var b=this.firebaseCallbacks_[a];b.ref.off(b.eventType,b.callback,b.context)}this.firebaseCallbacks_=[]},a}();